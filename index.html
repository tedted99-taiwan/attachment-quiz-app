<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>依戀屬性專業分析測驗 - 黑森林大叔</title>
    <!-- 引入 Tailwind CSS 進行排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        
        /* 滑塊樣式優化 */
        .slider { -webkit-appearance: none; width: 100%; height: 8px; background: #ddd; border-radius: 5px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: #4f46e5; border-radius: 50%; cursor: pointer; transition: 0.2s; }
        .slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        /* 座標圖樣式 */
        .quadrant-grid {
            position: relative;
            width: 300px;
            height: 300px;
            border: 2px solid #333;
            margin: 0 auto;
            background-image: 
                linear-gradient(#e5e7eb 1px, transparent 1px),
                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 150px 150px;
            background-position: -2px -2px;
        }
        /* 軸線標籤 */
        .axis-label { position: absolute; font-size: 12px; color: #666; font-weight: bold; padding: 2px 4px; background: rgba(255,255,255,0.8); border-radius: 4px; }
        
        /* 使用者落點 (紅點) */
        .dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: #ef4444; /* 紅色 */
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, 50%); /* 修正中心點對齊 */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 1s ease-out;
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 md:p-10 my-8">
        
        <!-- 商標顯示區 -->
        <div class="text-center mb-6">
            <!-- 請確保圖片檔案 1000075381.png 與此 html 檔在同一目錄下 -->
            <!-- 圖片載入失敗時，使用文字作為備用標誌 -->
            <img src="1000075381.png" alt="黑森林大叔" class="mx-auto w-32 h-auto object-contain mb-2" onerror="this.style.display='none'; document.getElementById('brand-text').style.display='block'">
            <h2 id="brand-text" class="text-xl font-bold text-gray-800 tracking-widest" style="display:none;">黑森林大叔</h2>
        </div>

        <header class="text-center mb-10 border-b pb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">依戀屬性專業分析</h1>
            <p class="text-gray-500 text-sm">請依照真實感受回答，系統將為您進行落點分析。</p>
            
            <div id="loading-indicator" class="mt-4 text-xs text-indigo-500 font-semibold animate-pulse">
                載入中... (準備完成後按鈕將啟用)
            </div>
        </header>

        <!-- 問題列表 -->
        <div id="questions-list" class="space-y-8">
            <!-- JavaScript 將自動生成題目 -->
        </div>
        
        <!-- 提交按鈕 -->
        <div class="mt-12">
            <button id="submit-button" class="w-full py-4 bg-indigo-600 text-white text-lg font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-all transform hover:-translate-y-1 disabled:bg-gray-400 disabled:cursor-not-allowed" onclick="calculateResult()" disabled>
                查看詳細分析報告
            </button>
            <p id="error-message" class="hidden mt-3 text-center text-red-500 font-medium"></p>
        </div>

    </div>

    <!-- 結果視窗 (Modal) -->
    <div id="result-modal" class="hidden fixed inset-0 bg-gray-900/90 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden my-8 relative">
            
            <!-- 關閉按鈕 -->
            <button onclick="resetQuiz()" class="absolute top-4 right-4 bg-indigo-600 p-2 rounded-full text-white hover:bg-indigo-700 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- 報告標頭 -->
            <div class="bg-indigo-600 p-6 text-center text-white">
                <p class="opacity-80 text-sm tracking-widest mb-1">黑森林大叔</p>
                <h2 class="text-2xl font-bold">依戀屬性分析報告</h2>
            </div>

            <div class="p-6 md:p-8 space-y-6">
                
                <!-- 分析結果標題 -->
                <div class="text-center">
                    <p class="text-gray-500 text-xs uppercase tracking-wide">您的依戀類型傾向</p>
                    <h3 id="result-title" class="text-3xl font-extrabold text-gray-800 mt-1"></h3>
                    <p id="result-subtitle" class="text-indigo-600 font-medium mt-2 text-base"></p>
                </div>

                <!-- 視覺化座標圖 -->
                <div class="flex flex-col items-center justify-center py-6 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-xs text-gray-400 mb-3 font-bold">您的心理落點座標圖</p>
                    <div class="quadrant-grid relative bg-white shadow-inner">
                        <!-- 軸標籤 -->
                        <span class="axis-label top-2 left-1/2 -translate-x-1/2 text-orange-600">高焦慮</span>
                        <span class="axis-label bottom-2 left-1/2 -translate-x-1/2 text-green-600">低焦慮</span>
                        <span class="axis-label top-1/2 right-2 -translate-y-1/2 text-blue-600">高迴避</span>
                        <span class="axis-label top-1/2 left-2 -translate-y-1/2 text-green-600">低迴避</span>
                        
                        <!-- 象限名稱 -->
                        <span class="absolute top-6 right-6 text-xs text-gray-300 font-bold pointer-events-none">混亂型</span>
                        <span class="absolute top-6 left-6 text-xs text-gray-300 font-bold pointer-events-none">焦慮型</span>
                        <span class="absolute bottom-6 right-6 text-xs text-gray-300 font-bold pointer-events-none">逃避型</span>
                        <span class="absolute bottom-6 left-6 text-xs text-gray-300 font-bold pointer-events-none">安全型</span>

                        <!-- 使用者落點 -->
                        <div id="user-dot" class="dot" style="bottom: 50%; left: 50%;"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">*紅點越接近中心，代表性格越趨於平衡安全</p>
                </div>

                <!-- 分數數值 -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-red-50 p-3 rounded-lg text-center border border-red-100">
                        <p class="text-xs text-red-500 font-bold mb-1">焦慮指數</p>
                        <p id="score-anxiety" class="text-2xl font-black text-red-600">0</p>
                        <p class="text-[10px] text-gray-400">分數越高代表越容易焦慮</p>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-100">
                        <p class="text-xs text-blue-500 font-bold mb-1">迴避指數</p>
                        <p id="score-avoidance" class="text-2xl font-black text-blue-600">0</p>
                        <p class="text-[10px] text-gray-400">分數越高代表越習慣逃避</p>
                    </div>
                </div>

                <!-- 詳細文字解釋 -->
                <div id="result-description" class="text-gray-700 text-sm leading-relaxed bg-gray-50 p-5 rounded-lg border-l-4 border-indigo-500 shadow-sm">
                    <!-- JS 動態插入描述 -->
                </div>

                <button onclick="resetQuiz()" class="w-full py-3 bg-gray-800 text-white font-bold rounded-lg hover:bg-gray-900 transition-colors shadow-lg">
                    重新測試
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // 注意：這裡已移除所有 Firebase 相關的 import，程式碼現在是完全獨立的。

        // 題目資料庫
        const questions = [
            { id: 1, text: "我經常擔心伴侶不像我愛他們那樣愛我。", dimension: 'anxiety' },
            { id: 2, text: "我需要經常得到伴侶的肯定和保證，才能感到安心。", dimension: 'anxiety' },
            { id: 3, text: "當伴侶疏遠我時，我會感到非常不安，並試圖拉近距離。", dimension: 'anxiety' },
            { id: 4, text: "在關係中，我會付出很多，即使委屈自己，以確保關係穩定。", dimension: 'anxiety' },
            { id: 5, text: "我害怕被拋棄或被拒絕，這會影響我在關係中的行為。", dimension: 'anxiety' },
            { id: 6, text: "我有時會過度分析伴侶的言行舉止，尋找潛在問題的線索。", dimension: 'anxiety' },
            { id: 7, text: "如果伴侶沒有即時回覆訊息或電話，我會感到很焦慮。", dimension: 'anxiety' },
            { id: 8, text: "我渴望與伴侶建立非常親密且依賴的關係，最好是形影不離。", dimension: 'anxiety' },
            { id: 9, text: "我傾向於在衝突後主動修復關係，即使不完全是我的錯。", dimension: 'anxiety' },
            { id: 10, text: "我的情緒經常受到伴侶行為的影響而起伏不定。", dimension: 'anxiety' },
            { id: 11, text: "我認為在親密關係中保持獨立和個人空間非常重要。", dimension: 'avoidance' },
            { id: 12, text: "當關係變得太親密時，我會想拉開距離或暫時抽離。", dimension: 'avoidance' },
            { id: 13, text: "我不喜歡依賴別人，也不喜歡別人太依賴我。", dimension: 'avoidance' },
            { id: 14, text: "發生爭執或情感壓力時，我通常選擇冷靜、退出討論或獨自解決。", dimension: 'avoidance' },
            { id: 15, text: "我發現很難向伴侶坦白我內心深處的想法或感受。", dimension: 'avoidance' },
            { id: 16, text: "我常常覺得伴侶對我的要求過多或過於黏膩。", dimension: 'avoidance' },
            { id: 17, text: "獨處時我感到最舒適自在，比與伴侶在一起更放鬆。", dimension: 'avoidance' },
            { id: 18, text: "即使我受傷或難過，我也會避免讓伴侶看到我的脆弱。", dimension: 'avoidance' },
            { id: 19, text: "我會避免討論關係中可能引起情感波動的話題。", dimension: 'avoidance' },
            { id: 20, text: "我努力讓自己相信，我能夠處理生活中的所有問題，不需要他人幫助。", dimension: 'avoidance' }
        ];

        // 初始化題目介面
        const questionsList = document.getElementById('questions-list');
        questions.forEach(q => {
            const div = document.createElement('div');
            // 加上 question-wrapper class，方便 DOM 存取
            div.className = "bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow question-wrapper"; 
            div.innerHTML = `
                <div class="mb-4">
                    <span class="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded mb-2">Q${q.id}</span>
                    <p class="text-base font-medium text-gray-800">${q.text}</p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between text-xs text-gray-400 font-bold px-1">
                        <span>非常不同意 (1)</span>
                        <span>非常同意 (5)</span>
                    </div>
                    <div class="relative flex items-center">
                        <input type="range" min="1" max="5" value="3" data-dimension="${q.dimension}" class="slider z-10" 
                               oninput="this.closest('.question-wrapper').querySelector('.output-val').innerText = this.value">
                    </div>
                    <div class="text-center text-indigo-600 font-bold text-lg mt-1 output-val">3</div>
                </div>
            `;
            questionsList.appendChild(div);
        });
        
        // 應用程式初始化 (取代 Firebase 連線)
        function initApp() {
            // 由於沒有外部連線，可以直接隱藏載入指示器並啟用按鈕
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('submit-button').disabled = false;
        }

        // 核心分析邏輯 (已移除儲存功能)
        window.calculateResult = async function() {
            const btn = document.getElementById('submit-button');
            const originalBtnText = btn.innerText;
            
            btn.disabled = true;
            btn.innerText = "正在分析數據...";

            const sliders = document.querySelectorAll('.slider');
            let anxietySum = 0, avoidanceSum = 0;
            sliders.forEach(s => {
                const val = parseInt(s.value);
                if (s.dataset.dimension === 'anxiety') anxietySum += val;
                else avoidanceSum += val;
            });

            // --- 依戀屬性分類邏輯 ---
            // 總分範圍：10 (min) ~ 50 (max)
            // 轉換為 0% ~ 100% 座標，用於視覺化
            const anxietyPercent = ((anxietySum - 10) / 40) * 100;
            const avoidancePercent = ((avoidanceSum - 10) / 40) * 100;

            // 分界點使用 30 (中間值) 作為高/低的標準
            const isHighAnx = anxietySum > 30; // 31-50
            const isHighAvd = avoidanceSum > 30; // 31-50
            
            let type = "", subtitle = "", color = "";

            if (!isHighAnx && !isHighAvd) {
                type = "安全型 (Secure)";
                color = "text-green-600";
                subtitle = "您擁有正向的自我價值感，並在關係中感到安全與舒適。";
            } else if (isHighAnx && !isHighAvd) {
                type = "焦慮型 (Anxious)";
                color = "text-orange-500";
                subtitle = "您非常渴望親密，但常因擔心被拋棄而過度投入或擔憂。";
            } else if (!isHighAnx && isHighAvd) {
                type = "逃避型 (Avoidant)";
                color = "text-blue-500";
                subtitle = "您傾向保持獨立和個人空間，對於過度親密感到不自在。";
            } else {
                type = "混亂型 (Disorganized)";
                color = "text-red-500";
                subtitle = "您既渴望親密又害怕受傷，內心常有矛盾的拉扯與掙扎。";
            }

            // 加入「模糊地帶」的註解 (27-33分視為中立區間)
            let caveat = "";
            const isBorderline = (score) => Math.abs(score - 30) <= 3; 
            
            if (isBorderline(anxietySum) && isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的分數非常接近中心點。這表示您的依戀風格並不明顯，或者您在不同情境下會展現不同特質（屬於安全型邊緣）。請參考上方的「落點座標圖」，紅點越接近十字中心，代表性格越平衡。`;
            } else if (isBorderline(anxietySum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「焦慮指數」位於中立區間，這代表您的焦慮特質並不強烈，可能只在特定高壓下才會出現。`;
            } else if (isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「迴避指數」位於中立區間，代表您並非完全排斥親密，只是需要一點個人空間，這是很健康的界線。`;
            }

            // 更新 UI 顯示
            document.getElementById('result-title').innerText = type;
            document.getElementById('result-title').className = `text-3xl font-extrabold mt-1 ${color}`;
            document.getElementById('result-subtitle').innerText = subtitle;
            document.getElementById('score-anxiety').innerText = anxietySum;
            document.getElementById('score-avoidance').innerText = avoidanceSum;
            document.getElementById('result-description').innerHTML = getDetailedDesc(type) + caveat;
            
            // 更新座標點位置
            const dot = document.getElementById('user-dot');
            dot.style.left = `${avoidancePercent}%`;
            dot.style.bottom = `${anxietyPercent}%`;

            // 顯示結果 Modal
            document.getElementById('result-modal').classList.remove('hidden');
            btn.innerText = originalBtnText; // 恢復按鈕文字
            btn.disabled = false;
        };

        window.resetQuiz = function() {
            document.getElementById('result-modal').classList.add('hidden');
            document.querySelectorAll('.slider').forEach(s => { 
                s.value = 3; 
                // 再次使用穩健的 DOM 存取方式來重置顯示值
                s.closest('.question-wrapper').querySelector('.output-val').innerText = "3";
            });
            window.scrollTo(0,0);
        };

        function getDetailedDesc(type) {
            if (type.includes("安全")) return "安全型依戀者通常擁有正向的自我價值感，也信任他人。這不代表您在關係中完全沒有問題，而是您有能力透過溝通與調節情緒來解決衝突，而不會採取過激的抗議行為或冷暴力。";
            if (type.includes("焦慮")) return "焦慮型依戀者對於「被拋棄」非常敏感。您非常善於察覺伴侶的情緒變化，但有時會過度解讀。您的挑戰在於學習自我安撫，相信「伴侶不在身邊」不等於「他不愛我」。";
            if (type.includes("逃避")) return "逃避型依戀者將「獨立」視為最高價值。您可能會無意識地壓抑對親密的需求，當伴侶試圖靠近時，您會感到窒息而想逃離。您的挑戰是理解「依賴」並不是軟弱，而是關係的一部分。";
            return "混亂型依戀者（又稱恐懼-逃避型）內心常有兩股力量在拉扯。您可能在童年經歷過無助的時刻，導致您想靠近人卻又怕受傷。這是一種自我保護機制，建議尋求專業諮商協助，建立內在的安全基地。";
        }

        window.onload = initApp; // 呼叫新的初始化函數
    </script>
</body>
</html>

 text: "發生爭執或情感壓力時，我通常選擇冷靜、退出討論或獨自解決。", dimension: 'avoidance' },
            { id: 15, text: "我發現很難向伴侶坦白我內心深處的想法或感受。", dimension: 'avoidance' },
            { id: 16, text: "我常常覺得伴侶對我的要求過多或過於黏膩。", dimension: 'avoidance' },
            { id: 17, text: "獨處時我感到最舒適自在，比與伴侶在一起更放鬆。", dimension: 'avoidance' },
            { id: 18, text: "即使我受傷或難過，我也會避免讓伴侶看到我的脆弱。", dimension: 'avoidance' },
            { id: 19, text: "我會避免討論關係中可能引起情感波動的話題。", dimension: 'avoidance' },
            { id: 20, text: "我努力讓自己相信，我能夠處理生活中的所有問題，不需要他人幫助。", dimension: 'avoidance' }
        ];

        // 初始化題目介面
        const questionsList = document.getElementById('questions-list');
        questions.forEach(q => {
            const div = document.createElement('div');
            // 加上 question-wrapper class，方便 DOM 存取
            div.className = "bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow question-wrapper"; 
            div.innerHTML = `
                <div class="mb-4">
                    <span class="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded mb-2">Q${q.id}</span>
                    <p class="text-base font-medium text-gray-800">${q.text}</p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between text-xs text-gray-400 font-bold px-1">
                        <span>非常不同意 (1)</span>
                        <span>非常同意 (5)</span>
                    </div>
                    <div class="relative flex items-center">
                        <!-- 修正 DOM 存取方式：使用 closest 和 querySelector 查找目標元素 -->
                        <input type="range" min="1" max="5" value="3" data-dimension="${q.dimension}" class="slider z-10" 
                               oninput="this.closest('.question-wrapper').querySelector('.output-val').innerText = this.value">
                    </div>
                    <div class="text-center text-indigo-600 font-bold text-lg mt-1 output-val">3</div>
                </div>
            `;
            questionsList.appendChild(div);
        });
        
        // 移除原有的 updateOutput 函式，因為已改為 inline 處理。

        // 初始化 Firebase
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 執行登入
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                // 監聽登入狀態並啟用按鈕
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('submit-button').disabled = false;
                    }
                });
            } catch (e) {
                console.error("Firebase 連線或登入失敗", e);
                document.getElementById('loading-indicator').innerText = "連線失敗，結果將不會儲存。";
                // 即使連線失敗，仍允許使用者計算，只是結果不會儲存
                document.getElementById('submit-button').disabled = false; 
            }
        }

        // 核心分析與儲存邏輯
        window.calculateAndSaveResult = async function() {
            const btn = document.getElementById('submit-button');
            const originalBtnText = btn.innerText;
            
            btn.disabled = true;
            btn.innerText = "正在分析數據...";

            const sliders = document.querySelectorAll('.slider');
            let anxietySum = 0, avoidanceSum = 0;
            sliders.forEach(s => {
                const val = parseInt(s.value);
                if (s.dataset.dimension === 'anxiety') anxietySum += val;
                else avoidanceSum += val;
            });

            // --- 依戀屬性分類邏輯 ---
            const anxietyPercent = ((anxietySum - 10) / 40) * 100;
            const avoidancePercent = ((avoidanceSum - 10) / 40) * 100;

            const isHighAnx = anxietySum > 30; // 31-50
            const isHighAvd = avoidanceSum > 30; // 31-50
            
            let type = "", subtitle = "", color = "";

            if (!isHighAnx && !isHighAvd) {
                type = "安全型 (Secure)";
                color = "text-green-600";
                subtitle = "您擁有正向的自我價值感，並在關係中感到安全與舒適。";
            } else if (isHighAnx && !isHighAvd) {
                type = "焦慮型 (Anxious)";
                color = "text-orange-500";
                subtitle = "您非常渴望親密，但常因擔心被拋棄而過度投入或擔憂。";
            } else if (!isHighAnx && isHighAvd) {
                type = "逃避型 (Avoidant)";
                color = "text-blue-500";
                subtitle = "您傾向保持獨立和個人空間，對於過度親密感到不自在。";
            } else {
                type = "混亂型 (Disorganized)";
                color = "text-red-500";
                subtitle = "您既渴望親密又害怕受傷，內心常有矛盾的拉扯與掙扎。";
            }

            // 加入「模糊地帶」的註解 (27-33分視為中立區間)
            let caveat = "";
            const isBorderline = (score) => Math.abs(score - 30) <= 3; 
            
            if (isBorderline(anxietySum) && isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的分數非常接近中心點。這表示您的依戀風格並不明顯，或者您在不同情境下會展現不同特質（屬於安全型邊緣）。請參考上方的「落點座標圖」，紅點越接近十字中心，代表性格越平衡。`;
            } else if (isBorderline(anxietySum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「焦慮指數」位於中立區間，這代表您的焦慮特質並不強烈，可能只在特定高壓下才會出現。`;
            } else if (isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「迴避指數」位於中立區間，代表您並非完全排斥親密，只是需要一點個人空間，這是很健康的界線。`;
            }

            // 更新 UI 顯示
            document.getElementById('result-title').innerText = type;
            document.getElementById('result-title').className = `text-3xl font-extrabold mt-1 ${color}`;
            document.getElementById('result-subtitle').innerText = subtitle;
            document.getElementById('score-anxiety').innerText = anxietySum;
            document.getElementById('score-avoidance').innerText = avoidanceSum;
            document.getElementById('result-description').innerHTML = getDetailedDesc(type) + caveat;
            
            // 更新座標點位置
            const dot = document.getElementById('user-dot');
            dot.style.left = `${avoidancePercent}%`;
            dot.style.bottom = `${anxietyPercent}%`;

            // 儲存資料 (只有在 isAuthReady 時才儲存，避免錯誤)
            if (isAuthReady) {
                try {
                    await addDoc(collection(db, QUIZ_COLLECTION_PATH), {
                        userId, anxietySum, avoidanceSum, type, timestamp: new Date().toISOString()
                    });
                } catch(e) { console.error("資料儲存失敗", e); }
            }

            // 顯示結果 Modal
            document.getElementById('result-modal').classList.remove('hidden');
            btn.innerText = originalBtnText; // 恢復按鈕文字
            btn.disabled = false;
        };

        window.resetQuiz = function() {
            document.getElementById('result-modal').classList.add('hidden');
            document.querySelectorAll('.slider').forEach(s => { 
                s.value = 3; 
                // 再次使用穩健的 DOM 存取方式來重置顯示值
                s.closest('.question-wrapper').querySelector('.output-val').innerText = "3";
            });
            window.scrollTo(0,0);
        };

        function getDetailedDesc(type) {
            if (type.includes("安全")) return "安全型依戀者通常擁有正向的自我價值感，也信任他人。這不代表您在關係中完全沒有問題，而是您有能力透過溝通與調節情緒來解決衝突，而不會採取過激的抗議行為或冷暴力。";
            if (type.includes("焦慮")) return "焦慮型依戀者對於「被拋棄」非常敏感。您非常善於察覺伴侶的情緒變化，但有時會過度解讀。您的挑戰在於學習自我安撫，相信「伴侶不在身邊」不等於「他不愛我」。";
            if (type.includes("逃避")) return "逃避型依戀者將「獨立」視為最高價值。您可能會無意識地壓抑對親密的需求，當伴侶試圖靠近時，您會感到窒息而想逃離。您的挑戰是理解「依賴」並不是軟弱，而是關係的一部分。";
            return "混亂型依戀者（又稱恐懼-逃避型）內心常有兩股力量在拉扯。您可能在童年經歷過無助的時刻，導致您想靠近人卻又怕受傷。這是一種自我保護機制，建議尋求專業諮商協助，建立內在的安全基地。";
        }

        window.onload = initFirebase;
    </script>
</body>
</html>

   { id: 16, text: "我常常覺得伴侶對我的要求過多或過於黏膩。", dimension: 'avoidance' },
            { id: 17, text: "獨處時我感到最舒適自在，比與伴侶在一起更放鬆。", dimension: 'avoidance' },
            { id: 18, text: "即使我受傷或難過，我也會避免讓伴侶看到我的脆弱。", dimension: 'avoidance' },
            { id: 19, text: "我會避免討論關係中可能引起情感波動的話題。", dimension: 'avoidance' },
            { id: 20, text: "我努力讓自己相信，我能夠處理生活中的所有問題，不需要他人幫助。", dimension: 'avoidance' }
        ];

        // 初始化題目介面
        const questionsList = document.getElementById('questions-list');
        questions.forEach(q => {
            const div = document.createElement('div');
            div.className = "bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow";
            div.innerHTML = `
                <div class="mb-4">
                    <span class="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded mb-2">Q${q.id}</span>
                    <p class="text-base font-medium text-gray-800">${q.text}</p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between text-xs text-gray-400 font-bold px-1">
                        <span>非常不同意</span>
                        <span>非常同意</span>
                    </div>
                    <div class="relative flex items-center">
                        <input type="range" min="1" max="5" value="3" data-dimension="${q.dimension}" class="slider z-10" oninput="updateOutput(this)">
                    </div>
                    <div class="text-center text-indigo-600 font-bold text-lg mt-1 output-val">3</div>
                </div>
            `;
            questionsList.appendChild(div);
        });

        window.updateOutput = function(el) {
            el.parentElement.nextElementSibling.innerText = el.value;
        }

        // 初始化 Firebase (移除人數統計邏輯，僅保留登入)
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('submit-button').disabled = false;
                        // 注意：此處已完全移除 updateCount 的呼叫，避免錯誤
                    }
                });
            } catch (e) {
                console.error("Firebase Error", e);
                document.getElementById('loading-indicator').innerText = "連線失敗，功能受限。";
            }
        }

        // 核心分析與儲存邏輯
        window.calculateAndSaveResult = async function() {
            if (!isAuthReady) {
                // 若未連線成功，仍允許計算顯示結果，但不儲存
                console.warn("未連線至資料庫，僅顯示本機結果");
            }
            
            const btn = document.getElementById('submit-button');
            btn.disabled = true;
            btn.innerText = "正在分析數據...";

            const sliders = document.querySelectorAll('.slider');
            let anxietySum = 0, avoidanceSum = 0;
            sliders.forEach(s => {
                const val = parseInt(s.value);
                if (s.dataset.dimension === 'anxiety') anxietySum += val;
                else avoidanceSum += val;
            });

            // --- 修正後的邏輯 ---
            // 滿分 50，最低 10。
            // 座標化：將分數轉換為 0% ~ 100% 的位置
            // 10分 -> 0%, 30分 -> 50%, 50分 -> 100%
            const anxietyPercent = ((anxietySum - 10) / 40) * 100;
            const avoidancePercent = ((avoidanceSum - 10) / 40) * 100;

            // 嚴格判定：大於 30 才算高 (31分以上)
            // 模糊地帶：27-33 分之間視為「中度」或「傾向不明顯」
            const isHighAnx = anxietySum > 30;
            const isHighAvd = avoidanceSum > 30;
            
            let type = "", subtitle = "";
            let color = "";

            if (!isHighAnx && !isHighAvd) {
                type = "安全型 (Secure)";
                color = "text-green-600";
                subtitle = "您在關係中感到舒適與安全，能平衡獨立與親密。";
            } else if (isHighAnx && !isHighAvd) {
                type = "焦慮型 (Anxious)";
                color = "text-orange-500";
                subtitle = "您渴望親密，但常擔心被對方拋棄或不夠愛自己。";
            } else if (!isHighAnx && isHighAvd) {
                type = "逃避型 (Avoidant)";
                color = "text-blue-500";
                subtitle = "您傾向保持距離與獨立，對於過度親密感到不自在。";
            } else {
                type = "混亂型 (Disorganized)";
                color = "text-red-500";
                subtitle = "您既渴望親密又害怕受傷，內心常處於矛盾與掙扎中。";
            }

            // 加入「模糊地帶」的註解，解決「不準確」的抱怨
            let caveat = "";
            const isBorderline = (score) => Math.abs(score - 30) <= 3; // 27-33分
            
            if (isBorderline(anxietySum) && isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的分數非常接近中心點。這表示您的依戀風格並不明顯，或者您在不同情境下會展現不同特質（屬於安全型邊緣）。請參考上方的「落點座標圖」，紅點越接近十字中心，代表性格越平衡。`;
            } else if (isBorderline(anxietySum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「焦慮指數」位於中立區間，這代表您的焦慮特質並不強烈，可能只在特定高壓下才會出現。`;
            } else if (isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「迴避指數」位於中立區間，代表您並非完全排斥親密，只是需要一點個人空間，這是很健康的界線。`;
            }

            // 更新 UI 顯示
            document.getElementById('result-title').innerText = type;
            document.getElementById('result-title').className = `text-3xl font-extrabold mt-1 ${color}`;
            document.getElementById('result-subtitle').innerText = subtitle;
            document.getElementById('score-anxiety').innerText = anxietySum;
            document.getElementById('score-avoidance').innerText = avoidanceSum;
            document.getElementById('result-description').innerHTML = getDetailedDesc(type) + caveat;
            
            // 更新座標點位置
            // X軸: 迴避 (左低右高) -> left: avoidancePercent%
            // Y軸: 焦慮 (下低上高) -> bottom: anxietyPercent%
            const dot = document.getElementById('user-dot');
            dot.style.left = `${avoidancePercent}%`;
            dot.style.bottom = `${anxietyPercent}%`;

            // 儲存資料 (只儲存，不讀取人數)
            if (isAuthReady) {
                try {
                    await addDoc(collection(db, QUIZ_COLLECTION_PATH), {
                        userId, anxietySum, avoidanceSum, type, timestamp: new Date().toISOString()
                    });
                } catch(e) { console.error("儲存失敗", e); }
            }

            // 顯示結果 Modal
            document.getElementById('result-modal').classList.remove('hidden');
            btn.innerText = "查看詳細分析報告";
            btn.disabled = false;
        };

        window.resetQuiz = function() {
            document.getElementById('result-modal').classList.add('hidden');
            document.querySelectorAll('.slider').forEach(s => { 
                s.value = 3; 
                s.parentElement.nextElementSibling.innerText = "3"; 
            });
            window.scrollTo(0,0);
        };

        function getDetailedDesc(type) {
            if (type.includes("安全")) return "安全型依戀者通常擁有正向的自我價值感，也信任他人。這不代表您在關係中完全沒有問題，而是您有能力透過溝通與調節情緒來解決衝突，而不會採取過激的抗議行為或冷暴力。";
            if (type.includes("焦慮")) return "焦慮型依戀者對於「被拋棄」非常敏感。您非常善於察覺伴侶的情緒變化，但有時會過度解讀。您的挑戰在於學習自我安撫，相信「伴侶不在身邊」不等於「他不愛我」。";
            if (type.includes("逃避")) return "逃避型依戀者將「獨立」視為最高價值。您可能會無意識地壓抑對親密的需求，當伴侶試圖靠近時，您會感到窒息而想逃離。您的挑戰是理解「依賴」並不是軟弱，而是關係的一部分。";
            return "混亂型依戀者（又稱恐懼-逃避型）內心常有兩股力量在拉扯。您可能在童年經歷過無助的時刻，導致您想靠近人卻又怕受傷。這是一種自我保護機制，建議尋求專業諮商協助，建立內在的安全基地。";
        }

        window.onload = initFirebase;
    </script>
</body>
</html>

  { id: 16, text: "我常常覺得伴侶對我的要求過多或過於黏膩。", dimension: 'avoidance' },
            { id: 17, text: "獨處時我感到最舒適自在，比與伴侶在一起更放鬆。", dimension: 'avoidance' },
            { id: 18, text: "即使我受傷或難過，我也會避免讓伴侶看到我的脆弱。", dimension: 'avoidance' },
            { id: 19, text: "我會避免討論關係中可能引起情感波動的話題。", dimension: 'avoidance' },
            { id: 20, text: "我努力讓自己相信，我能夠處理生活中的所有問題，不需要他人幫助。", dimension: 'avoidance' }
        ];

        // 初始化題目介面
        const questionsList = document.getElementById('questions-list');
        questions.forEach(q => {
            const div = document.createElement('div');
            div.className = "bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow";
            div.innerHTML = `
                <div class="mb-4">
                    <span class="inline-block px-2 py-1 bg-gray-100 text-gray-500 text-xs font-bold rounded mb-2">Q${q.id}</span>
                    <p class="text-base font-medium text-gray-800">${q.text}</p>
                </div>
                <div class="flex flex-col gap-2">
                    <div class="flex justify-between text-xs text-gray-400 font-bold px-1">
                        <span>非常不同意</span>
                        <span>非常同意</span>
                    </div>
                    <div class="relative flex items-center">
                        <input type="range" min="1" max="5" value="3" data-dimension="${q.dimension}" class="slider z-10" oninput="updateOutput(this)">
                    </div>
                    <div class="text-center text-indigo-600 font-bold text-lg mt-1 output-val">3</div>
                </div>
            `;
            questionsList.appendChild(div);
        });

        window.updateOutput = function(el) {
            el.parentElement.nextElementSibling.innerText = el.value;
        }

        // 初始化 Firebase (移除人數統計邏輯，僅保留登入)
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                else await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('submit-button').disabled = false;
                        // 注意：此處已完全移除 updateCount 的呼叫，避免錯誤
                    }
                });
            } catch (e) {
                console.error("Firebase Error", e);
                document.getElementById('loading-indicator').innerText = "連線失敗，功能受限。";
            }
        }

        // 核心分析與儲存邏輯
        window.calculateAndSaveResult = async function() {
            if (!isAuthReady) {
                // 若未連線成功，仍允許計算顯示結果，但不儲存
                console.warn("未連線至資料庫，僅顯示本機結果");
            }
            
            const btn = document.getElementById('submit-button');
            btn.disabled = true;
            btn.innerText = "正在分析數據...";

            const sliders = document.querySelectorAll('.slider');
            let anxietySum = 0, avoidanceSum = 0;
            sliders.forEach(s => {
                const val = parseInt(s.value);
                if (s.dataset.dimension === 'anxiety') anxietySum += val;
                else avoidanceSum += val;
            });

            // --- 修正後的邏輯 ---
            // 滿分 50，最低 10。
            // 座標化：將分數轉換為 0% ~ 100% 的位置
            // 10分 -> 0%, 30分 -> 50%, 50分 -> 100%
            const anxietyPercent = ((anxietySum - 10) / 40) * 100;
            const avoidancePercent = ((avoidanceSum - 10) / 40) * 100;

            // 嚴格判定：大於 30 才算高 (31分以上)
            // 模糊地帶：27-33 分之間視為「中度」或「傾向不明顯」
            const isHighAnx = anxietySum > 30;
            const isHighAvd = avoidanceSum > 30;
            
            let type = "", subtitle = "";
            let color = "";

            if (!isHighAnx && !isHighAvd) {
                type = "安全型 (Secure)";
                color = "text-green-600";
                subtitle = "您在關係中感到舒適與安全，能平衡獨立與親密。";
            } else if (isHighAnx && !isHighAvd) {
                type = "焦慮型 (Anxious)";
                color = "text-orange-500";
                subtitle = "您渴望親密，但常擔心被對方拋棄或不夠愛自己。";
            } else if (!isHighAnx && isHighAvd) {
                type = "逃避型 (Avoidant)";
                color = "text-blue-500";
                subtitle = "您傾向保持距離與獨立，對於過度親密感到不自在。";
            } else {
                type = "混亂型 (Disorganized)";
                color = "text-red-500";
                subtitle = "您既渴望親密又害怕受傷，內心常處於矛盾與掙扎中。";
            }

            // 加入「模糊地帶」的註解，解決「不準確」的抱怨
            let caveat = "";
            const isBorderline = (score) => Math.abs(score - 30) <= 3; // 27-33分
            
            if (isBorderline(anxietySum) && isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的分數非常接近中心點。這表示您的依戀風格並不明顯，或者您在不同情境下會展現不同特質（屬於安全型邊緣）。請參考上方的「落點座標圖」，紅點越接近十字中心，代表性格越平衡。`;
            } else if (isBorderline(anxietySum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「焦慮指數」位於中立區間，這代表您的焦慮特質並不強烈，可能只在特定高壓下才會出現。`;
            } else if (isBorderline(avoidanceSum)) {
                caveat = `<br><br><strong class="text-indigo-600">💡 黑森林大叔筆記：</strong> 您的「迴避指數」位於中立區間，代表您並非完全排斥親密，只是需要一點個人空間，這是很健康的界線。`;
            }

            // 更新 UI 顯示
            document.getElementById('result-title').innerText = type;
            document.getElementById('result-title').className = `text-3xl font-extrabold mt-1 ${color}`;
            document.getElementById('result-subtitle').innerText = subtitle;
            document.getElementById('score-anxiety').innerText = anxietySum;
            document.getElementById('score-avoidance').innerText = avoidanceSum;
            document.getElementById('result-description').innerHTML = getDetailedDesc(type) + caveat;
            
            // 更新座標點位置
            // X軸: 迴避 (左低右高) -> left: avoidancePercent%
            // Y軸: 焦慮 (下低上高) -> bottom: anxietyPercent%
            const dot = document.getElementById('user-dot');
            dot.style.left = `${avoidancePercent}%`;
            dot.style.bottom = `${anxietyPercent}%`;

            // 儲存資料 (只儲存，不讀取人數)
            if (isAuthReady) {
                try {
                    await addDoc(collection(db, QUIZ_COLLECTION_PATH), {
                        userId, anxietySum, avoidanceSum, type, timestamp: new Date().toISOString()
                    });
                } catch(e) { console.error("儲存失敗", e); }
            }

            // 顯示結果 Modal
            document.getElementById('result-modal').classList.remove('hidden');
            btn.innerText = "查看詳細分析報告";
            btn.disabled = false;
        };

        window.resetQuiz = function() {
            document.getElementById('result-modal').classList.add('hidden');
            document.querySelectorAll('.slider').forEach(s => { 
                s.value = 3; 
                s.parentElement.nextElementSibling.innerText = "3"; 
            });
            window.scrollTo(0,0);
        };

        function getDetailedDesc(type) {
            if (type.includes("安全")) return "安全型依戀者通常擁有正向的自我價值感，也信任他人。這不代表您在關係中完全沒有問題，而是您有能力透過溝通與調節情緒來解決衝突，而不會採取過激的抗議行為或冷暴力。";
            if (type.includes("焦慮")) return "焦慮型依戀者對於「被拋棄」非常敏感。您非常善於察覺伴侶的情緒變化，但有時會過度解讀。您的挑戰在於學習自我安撫，相信「伴侶不在身邊」不等於「他不愛我」。";
            if (type.includes("逃避")) return "逃避型依戀者將「獨立」視為最高價值。您可能會無意識地壓抑對親密的需求，當伴侶試圖靠近時，您會感到窒息而想逃離。您的挑戰是理解「依賴」並不是軟弱，而是關係的一部分。";
            return "混亂型依戀者（又稱恐懼-逃避型）內心常有兩股力量在拉扯。您可能在童年經歷過無助的時刻，導致您想靠近人卻又怕受傷。這是一種自我保護機制，建議尋求專業諮商協助，建立內在的安全基地。";
        }

        window.onload = initFirebase;
    </script>
</body>
</html>

