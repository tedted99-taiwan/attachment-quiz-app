<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>依戀屬性快速測驗</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* 自定義滑塊樣式 */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-start justify-center">


    <div id="quiz-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 md:p-8 mt-8">
        
        <!-- 標題區塊 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800">依戀屬性快速測驗</h1>
            <p class="text-gray-500 mt-2">請根據您的真實感受，在以下陳述句中選擇您的同意程度。</p>
            
            <!-- 載入狀態 / 統計人數顯示 -->
            <div id="loading-indicator" class="mt-4 text-indigo-500 font-semibold">
                正在載入資料庫...
            </div>
            <div id="participant-count" class="hidden mt-4 p-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold">
                <!-- 統計人數將顯示在這裡 -->
            </div>


        </header>


        <!-- 問卷問題區塊 -->
        <div id="questions-list">
            <!-- JavaScript 會在這裡插入問題 -->
        </div>
        
        <!-- 按鈕區塊 -->
        <div id="quiz-control" class="mt-10">
            <button id="submit-button" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-4 focus:ring-indigo-500/50" onclick="calculateAndSaveResult()" disabled>
                查看並儲存我的依戀屬性
            </button>
        </div>


        <!-- 結果區塊 (預設隱藏) -->
        <div id="result-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-lg transform scale-100 transition-transform duration-300">
                <h2 class="text-3xl font-bold mb-4 text-center text-indigo-600">您的依戀屬性分析</h2>
                
                <div class="space-y-4">
                    <p class="text-lg font-semibold text-gray-700">您傾向於： <span id="attachment-style" class="text-indigo-600 font-extrabold text-2xl"></span></p>
                    
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-medium text-red-500">焦慮程度得分 (Anxiety):</span>
                            <span id="anxiety-score" class="font-bold text-red-500 text-xl">0</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-medium text-blue-500">迴避程度得分 (Avoidance):</span>
                            <span id="avoidance-score" class="font-bold text-blue-500 text-xl">0</span>
                        </div>
                    </div>
                    
                    <div id="style-description" class="bg-indigo-50 p-4 rounded-lg text-gray-800">
                        <!-- 依戀屬性描述會在這裡顯示 -->
                    </div>
                    
                    <div id="final-count" class="mt-4 p-3 bg-green-100 text-green-700 rounded-lg font-bold text-center">
                        <!-- 最終統計人數將顯示在這裡 -->
                    </div>
                </div>


                <button class="mt-6 w-full py-2 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400 transition-colors" onclick="resetQuiz()">
                    重新測試
                </button>
            </div>
        </div>
        
        <!-- 錯誤訊息提示 (預設隱藏) -->
        <div id="error-message" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center font-medium">
            請回答所有問題後再提交。
        </div>


    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // 設定 Firebase Log 級別為 Debug (用於偵錯)
        setLogLevel('Debug');
        
        // 全域變數
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;


        // 必須使用環境提供的變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        const QUIZ_COLLECTION_PATH = `artifacts/${appId}/public/data/quiz_results`;


        // 問卷問題定義 (略)
        const questions = [
            { id: 1, text: "我經常擔心伴侶不像我愛他們那樣愛我。", dimension: 'anxiety' },
            { id: 2, text: "我需要經常得到伴侶的肯定和保證，才能感到安心。", dimension: 'anxiety' },
            { id: 3, text: "當伴侶疏遠我時，我會感到非常不安，並試圖拉近距離。", dimension: 'anxiety' },
            { id: 4, text: "在關係中，我會付出很多，即使委屈自己，以確保關係穩定。", dimension: 'anxiety' },
            { id: 5, text: "我害怕被拋棄或被拒絕，這會影響我在關係中的行為。", dimension: 'anxiety' },
            { id: 6, text: "我有時會過度分析伴侶的言行舉止，尋找潛在問題的線索。", dimension: 'anxiety' },
            { id: 7, text: "如果伴侶沒有即時回覆訊息或電話，我會感到很焦慮。", dimension: 'anxiety' },
            { id: 8, text: "我渴望與伴侶建立非常親密且依賴的關係，最好是形影不離。", dimension: 'anxiety' },
            { id: 9, text: "我傾向於在衝突後主動修復關係，即使不完全是我的錯。", dimension: 'anxiety' },
            { id: 10, text: "我的情緒經常受到伴侶行為的影響而起伏不定。", dimension: 'anxiety' },
            { id: 11, text: "我認為在親密關係中保持獨立和個人空間非常重要。", dimension: 'avoidance' },
            { id: 12, text: "當關係變得太親密時，我會想拉開距離或暫時抽離。", dimension: 'avoidance' },
            { id: 13, text: "我不喜歡依賴別人，也不喜歡別人太依賴我。", dimension: 'avoidance' },
            { id: 14, text: "發生爭執或情感壓力時，我通常選擇冷靜、退出討論或獨自解決。", dimension: 'avoidance' },
            { id: 15, text: "我發現很難向伴侶坦白我內心深處的想法或感受。", dimension: 'avoidance' },
            { id: 16, text: "我常常覺得伴侶對我的要求過多或過於黏膩。", dimension: 'avoidance' },
            { id: 17, text: "獨處時我感到最舒適自在，比與伴侶在一起更放鬆。", dimension: 'avoidance' },
            { id: 18, text: "即使我受傷或難過，我也會避免讓伴侶看到我的脆弱。", dimension: 'avoidance' },
            { id: 19, text: "我會避免討論關係中可能引起情感波動的話題。", dimension: 'avoidance' },
            { id: 20, text: "我努力讓自己相信，我能夠處理生活中的所有問題，不需要他人幫助。", dimension: 'avoidance' }
        ];


        // 依戀屬性描述
        const descriptions = {
            secure: {
                style: "安全型依戀 (Secure)",
                color: "text-green-600",
                description: "恭喜您！安全型依戀者對親密關係抱持積極態度。您在關係中既能獨立自主，也能在需要時尋求支持。您相信自己值得被愛，也相信伴侶是可靠的。這有助於建立穩定、和諧的長期關係。"
            },
            anxious: {
                style: "焦慮型依戀 (Anxious-Preoccupied)",
                color: "text-orange-600",
                description: "焦慮型依戀者渴望親密但又充滿不安全感。您可能容易患得患失，需要伴侶不斷地確認和保證。請嘗試學習**自我安撫**，並相信您的價值不依賴於伴侶的行為。"
            },
            avoidant: {
                style: "逃避型依戀 (Avoidant-Dismissing)",
                color: "text-blue-600",
                description: "逃避型依戀者高度重視獨立和個人空間。當關係變得親密時，您可能會傾向於拉開距離或迴避情感交流。請嘗試練習**情感表達**，允許自己在關係中展現脆弱，以建立更深層的連結。"
            },
            disorganized: {
                style: "混亂型依戀 (Disorganized/Fearful-Avoidant)",
                color: "text-red-600",
                description: "混亂型依戀者同時擁有高焦慮和高迴避的特質。您既渴望親密又害怕親密，這導致關係中的行為模式不穩定且充滿矛盾。這通常與童年複雜的依戀經驗有關。建議尋求**專業支持**，幫助建立更一致的內在安全感。"
            }
        };


        // DOM 元素參考
        const questionsList = document.getElementById('questions-list');
        const submitButton = document.getElementById('submit-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const participantCountDisplay = document.getElementById('participant-count');


        // 初始化 Firebase 和認證
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);


                // 處理認證狀態
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }


                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase 認證成功，使用者 ID:", userId);
                        loadingIndicator.textContent = "資料庫連線成功。";
                        submitButton.disabled = false; // 認證完成後啟用按鈕
                        fetchParticipantCount(); // 認證成功後抓取總人數
                    } else {
                        console.error("Firebase 認證失敗，或使用者已登出。");
                    }
                });
            } catch (error) {
                console.error("Firebase 初始化或認證錯誤:", error);
                loadingIndicator.textContent = `連線錯誤: ${error.message}`;
            }
        }


        // 取得並顯示總參與人數
        async function fetchParticipantCount() {
            if (!isAuthReady) return;


            try {
                const querySnapshot = await getDocs(collection(db, QUIZ_COLLECTION_PATH));
                const count = querySnapshot.size;
                participantCountDisplay.textContent = `目前已有 ${count} 位參與者完成測驗。`;
                participantCountDisplay.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                return count;
            } catch (error) {
                console.error("讀取參與人數錯誤:", error);
                participantCountDisplay.textContent = '無法讀取參與人數。';
                participantCountDisplay.classList.remove('hidden');
                loadingIndicator.classList.add('hidden');
                return 0;
            }
        }


        // 更新滑塊顯示的數值
        function updateSliderValue(slider) {
            document.getElementById(`value-${slider.dataset.id}`).textContent = slider.value;
        }


        // 計算並保存結果
        async function calculateAndSaveResult() {
            if (!isAuthReady) {
                // 如果認證未準備好，顯示錯誤訊息並返回
                document.getElementById('error-message').textContent = "資料庫尚未連線成功，請稍候再試。";
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }


            const sliders = document.querySelectorAll('.slider');
            let totalAnxietyScore = 0;
            let totalAvoidanceScore = 0;
            let allAnswered = true;


            // 計算分數
            sliders.forEach(slider => {
                const score = parseInt(slider.value, 10);
                if (slider.dataset.dimension === 'anxiety') {
                    totalAnxietyScore += score;
                } else if (slider.dataset.dimension === 'avoidance') {
                    totalAvoidanceScore += score;
                }
            });


            // 分類邏輯
            const THRESHOLD = 30; 
            const isHighAnxiety = totalAnxietyScore >= THRESHOLD;
            const isHighAvoidance = totalAvoidanceScore >= THRESHOLD;


            let resultKey;
            if (!isHighAnxiety && !isHighAvoidance) {
                resultKey = 'secure'; 
            } else if (isHighAnxiety && !isHighAvoidance) {
                resultKey = 'anxious'; 
            } else if (!isHighAnxiety && isHighAvoidance) {
                resultKey = 'avoidant'; 
            } else {
                resultKey = 'disorganized'; 
            }


            // 儲存結果到 Firestore
            try {
                await addDoc(collection(db, QUIZ_COLLECTION_PATH), {
                    userId: userId,
                    anxietyScore: totalAnxietyScore,
                    avoidanceScore: totalAvoidanceScore,
                    attachmentStyle: resultKey,
                    timestamp: new Date().toISOString()
                });
                console.log("測驗結果已成功儲存到 Firestore！");
                document.getElementById('error-message').classList.add('hidden');


                // 儲存成功後，顯示結果並更新統計人數
                showResult(totalAnxietyScore, totalAvoidanceScore, resultKey);
                const newCount = await fetchParticipantCount();
                document.getElementById('final-count').textContent = `感謝您的參與！目前總共有 ${newCount} 位參與者完成了測驗。`;


            } catch (error) {
                console.error("儲存結果錯誤:", error);
                // 使用自定義訊息框替代 alert
                document.getElementById('error-message').textContent = `儲存結果失敗：${error.message}。`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }


        // 顯示結果視窗
        function showResult(anxiety, avoidance, key) {
            const result = descriptions[key];
            document.getElementById('attachment-style').textContent = result.style;
            document.getElementById('attachment-style').className = `font-extrabold text-2xl ${result.color}`;
            document.getElementById('anxiety-score').textContent = anxiety;
            document.getElementById('avoidance-score').textContent = avoidance;
            document.getElementById('style-description').innerHTML = `
                <p class="font-bold text-lg mb-2 ${result.color}">${result.style} 特徵：</p>
                <p>${result.description}</p>
            `;
            document.getElementById('result-modal').classList.remove('hidden');
        }


        // 初始化問卷問題
        function initQuiz() {
            questionsList.innerHTML = '';
            questions.forEach(q => {
                const questionElement = document.createElement('div');
                questionElement.className = 'question-card bg-gray-50 p-4 mb-4 rounded-lg border border-gray-200 transition-shadow duration-300 hover:shadow-md';
                questionElement.innerHTML = `
                    <p class="text-base font-semibold text-gray-800 mb-3">${q.id}. ${q.text}</p>
                    <div class="flex justify-between text-sm text-gray-500 mb-2">
                        <span>非常不同意 (1)</span>
                        <span>非常同意 (5)</span>
                    </div>
                    <input type="range" min="1" max="5" value="3" data-id="${q.id}" data-dimension="${q.dimension}" class="slider" onchange="updateSliderValue(this)">
                    <p class="text-right text-base font-bold text-indigo-600 mt-1" id="value-${q.id}">3</p>
                `;
                questionsList.appendChild(questionElement);
            });
        }


        // 重新開始測驗
        function resetQuiz() {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            initQuiz(); // 重置滑塊
        }


        // 頁面載入時初始化 Firebase 和問卷
        window.onload = () => {
            initQuiz();
            initializeFirebase();
        };


        // 將計算函式暴露給 HTML 按鈕
        window.calculateAndSaveResult = calculateAndSaveResult;
        window.updateSliderValue = updateSliderValue;
        window.resetQuiz = resetQuiz;
    </script>


</body>
</html>